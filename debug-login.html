<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Login - Firebase Auth</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .debug-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .debug-section h3 {
            margin-top: 0;
            color: #333;
        }
        .debug-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button.google {
            background: #4285f4;
        }
        .button.apple {
            background: #000;
        }
        .button.line {
            background: #00b900;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .status.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üêõ Debug Login - Firebase Auth</h1>
        <p>‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö debug ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</p>

        <!-- Firebase Config Debug -->
        <div class="debug-section">
            <h3>1. Firebase Configuration</h3>
            <div id="firebaseConfig" class="debug-info">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        </div>

        <!-- Auth State Debug -->
        <div class="debug-section">
            <h3>2. Auth State</h3>
            <div id="authState" class="debug-info">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</div>
        </div>

        <!-- Console Logs -->
        <div class="debug-section">
            <h3>3. Console Logs</h3>
            <button class="button" onclick="clearLogs()">Clear Logs</button>
            <div id="consoleLogs" class="debug-info">‡∏£‡∏≠ logs...</div>
        </div>

        <!-- Login Buttons -->
        <div class="debug-section">
            <h3>4. Test Login</h3>
            <button class="button google" onclick="testGoogleLogin()">Test Google Login</button>
            <button class="button apple" onclick="testAppleLogin()">Test Apple Login</button>
            <button class="button line" onclick="testLineLogin()">Test LINE Login</button>
            <button class="button" onclick="testEmailLogin()">Test Email Login</button>
        </div>

        <!-- Error Display -->
        <div class="debug-section">
            <h3>5. Errors</h3>
            <div id="errorDisplay" class="debug-info">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
            getAuth,
            signInWithPopup,
            GoogleAuthProvider,
            OAuthProvider,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC4pMv-UMVU4hqkSV-FaEiA1Z0txFo9j0I",
            authDomain: "traveltech-f0674.firebaseapp.com",
            projectId: "traveltech-f0674",
            storageBucket: "traveltech-f0674.firebasestorage.app",
            messagingSenderId: "843584449870",
            appId: "1:843584449870:web:c5c49bc62b7afe609d021f",
            measurementId: "G-2M28EEC4W7",
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Initialize providers
        const googleProvider = new GoogleAuthProvider();
        const appleProvider = new OAuthProvider("apple.com");

        // Debug info
        let consoleLogs = [];
        let originalConsoleLog = console.log;
        let originalConsoleError = console.error;

        // Override console methods to capture logs
        console.log = function(...args) {
            consoleLogs.push({ type: 'log', message: args.join(' '), timestamp: new Date().toISOString() });
            originalConsoleLog.apply(console, args);
            updateConsoleLogs();
        };

        console.error = function(...args) {
            consoleLogs.push({ type: 'error', message: args.join(' '), timestamp: new Date().toISOString() });
            originalConsoleError.apply(console, args);
            updateConsoleLogs();
        };

        // Update console logs display
        function updateConsoleLogs() {
            const logsElement = document.getElementById('consoleLogs');
            if (logsElement) {
                logsElement.textContent = consoleLogs
                    .slice(-20) // Show last 20 logs
                    .map(log => `[${log.timestamp}] ${log.type.toUpperCase()}: ${log.message}`)
                    .join('\n');
            }
        }

        // Clear logs
        function clearLogs() {
            consoleLogs = [];
            updateConsoleLogs();
        }

        // Display Firebase config
        function displayFirebaseConfig() {
            const configElement = document.getElementById('firebaseConfig');
            if (configElement) {
                configElement.textContent = JSON.stringify(firebaseConfig, null, 2);
            }
        }

        // Display auth state
        function displayAuthState() {
            const authStateElement = document.getElementById('authState');
            if (authStateElement) {
                const user = auth.currentUser;
                const authState = {
                    currentUser: user ? {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName,
                        emailVerified: user.emailVerified,
                        providerData: user.providerData
                    } : null,
                    isInitialized: true,
                    timestamp: new Date().toISOString()
                };
                authStateElement.textContent = JSON.stringify(authState, null, 2);
            }
        }

        // Display error
        function displayError(error) {
            const errorElement = document.getElementById('errorDisplay');
            if (errorElement) {
                errorElement.textContent = JSON.stringify({
                    message: error.message,
                    code: error.code,
                    stack: error.stack,
                    timestamp: new Date().toISOString()
                }, null, 2);
            }
        }

        // Test Google Login
        async function testGoogleLogin() {
            try {
                console.log('üîë Testing Google login...');
                googleProvider.addScope("email");
                googleProvider.addScope("profile");
                
                const result = await signInWithPopup(auth, googleProvider);
                console.log('‚úÖ Google login successful:', result.user);
                
                // Show success message
                const statusDiv = document.createElement('div');
                statusDiv.className = 'status success';
                statusDiv.textContent = 'Google login successful!';
                document.querySelector('.debug-section:nth-child(4)').appendChild(statusDiv);
                
            } catch (error) {
                console.error('‚ùå Google login error:', error);
                displayError(error);
                
                // Show error message
                const statusDiv = document.createElement('div');
                statusDiv.className = 'status error';
                statusDiv.textContent = `Google login failed: ${error.message}`;
                document.querySelector('.debug-section:nth-child(4)').appendChild(statusDiv);
            }
        }

        // Test Apple Login
        async function testAppleLogin() {
            try {
                console.log('üçé Testing Apple login...');
                appleProvider.addScope("email");
                appleProvider.addScope("name");
                
                const result = await signInWithPopup(auth, appleProvider);
                console.log('‚úÖ Apple login successful:', result.user);
                
                // Show success message
                const statusDiv = document.createElement('div');
                statusDiv.className = 'status success';
                statusDiv.textContent = 'Apple login successful!';
                document.querySelector('.debug-section:nth-child(4)').appendChild(statusDiv);
                
            } catch (error) {
                console.error('‚ùå Apple login error:', error);
                displayError(error);
                
                // Show error message
                const statusDiv = document.createElement('div');
                statusDiv.className = 'status error';
                statusDiv.textContent = `Apple login failed: ${error.message}`;
                document.querySelector('.debug-section:nth-child(4)').appendChild(statusDiv);
            }
        }

        // Test LINE Login
        async function testLineLogin() {
            try {
                console.log('üü© Testing LINE login...');
                
                const response = await fetch('http://localhost:3000/api/auth/line/auth-url');
                const data = await response.json();
                
                if (data.success) {
                    console.log('‚úÖ Got LINE auth URL:', data.authUrl);
                    window.location.href = data.authUrl;
                } else {
                    throw new Error(data.error || 'Failed to get LINE auth URL');
                }
                
            } catch (error) {
                console.error('‚ùå LINE login error:', error);
                displayError(error);
                
                // Show error message
                const statusDiv = document.createElement('div');
                statusDiv.className = 'status error';
                statusDiv.textContent = `LINE login failed: ${error.message}`;
                document.querySelector('.debug-section:nth-child(4)').appendChild(statusDiv);
            }
        }

        // Test Email Login
        async function testEmailLogin() {
            try {
                console.log('üìß Testing Email login...');
                
                const email = prompt('Enter email:');
                const password = prompt('Enter password:');
                
                if (!email || !password) {
                    throw new Error('Email and password are required');
                }
                
                const result = await signInWithEmailAndPassword(auth, email, password);
                console.log('‚úÖ Email login successful:', result.user);
                
                // Show success message
                const statusDiv = document.createElement('div');
                statusDiv.className = 'status success';
                statusDiv.textContent = 'Email login successful!';
                document.querySelector('.debug-section:nth-child(4)').appendChild(statusDiv);
                
            } catch (error) {
                console.error('‚ùå Email login error:', error);
                displayError(error);
                
                // Show error message
                const statusDiv = document.createElement('div');
                statusDiv.className = 'status error';
                statusDiv.textContent = `Email login failed: ${error.message}`;
                document.querySelector('.debug-section:nth-child(4)').appendChild(statusDiv);
            }
        }

        // Auth state listener
        onAuthStateChanged(auth, (user) => {
            console.log('Auth state changed:', user ? 'User logged in' : 'No user');
            displayAuthState();
        });

        // Initialize debug info
        displayFirebaseConfig();
        displayAuthState();
        updateConsoleLogs();

        // Make functions global for onclick handlers
        window.testGoogleLogin = testGoogleLogin;
        window.testAppleLogin = testAppleLogin;
        window.testLineLogin = testLineLogin;
        window.testEmailLogin = testEmailLogin;
        window.clearLogs = clearLogs;
    </script>
</body>
</html>
