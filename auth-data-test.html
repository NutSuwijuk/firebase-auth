<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Auth Data Test - Phone & Email Verification</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .test-section {
            margin-bottom: 40px;
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 15px;
        }

        .test-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 22px;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .button {
            padding: 15px 20px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .button:hover {
            transform: translateY(-2px);
        }

        .button.google {
            background: #4285f4;
            color: white;
        }

        .button.apple {
            background: #000;
            color: white;
        }

        .button.line {
            background: #00b900;
            color: white;
        }

        .button.secondary {
            background: #6c757d;
            color: white;
        }

        .data-display {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .data-display.show {
            display: block;
        }

        .data-section {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .data-section h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .data-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .data-item:last-child {
            border-bottom: none;
        }

        .data-label {
            font-weight: 600;
            color: #555;
            min-width: 200px;
        }

        .data-value {
            color: #333;
            word-break: break-all;
        }

        .verification-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .verified {
            background: #d4edda;
            color: #155724;
        }

        .not-verified {
            background: #f8d7da;
            color: #721c24;
        }

        .unknown {
            background: #fff3cd;
            color: #856404;
        }

        .provider-icon {
            width: 20px;
            height: 20px;
        }

        .summary {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .summary h3 {
            color: #1976d2;
            margin-bottom: 15px;
        }

        .summary-item {
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }

        .summary-item strong {
            color: #333;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Firebase Auth Data Test</h1>
            <p>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Google, Apple, ‡πÅ‡∏•‡∏∞ LINE Authentication</p>
            <p><strong>Focus:</strong> Phone Number ‡πÅ‡∏•‡∏∞ Email Verification Status</p>
        </div>

        <div class="test-section">
            <h2>üîê Authentication Providers</h2>
            <div class="button-group">
                <button id="googleLoginBtn" class="button google">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIyLjU2IDEyLjI1QzIyLjU2IDExLjQ3IDIyLjQ5IDEwLjcyIDIyLjM2IDEwSDEyVjE0LjI1SDE3LjkyQzE3LjY2IDE1LjYzIDE2LjkyIDE2Ljc5IDE1LjY4IDE3LjU3VjIwLjI2SDE5LjY4QzIxLjU2IDE4LjYzIDIyLjU2IDE1LjY5IDIyLjU2IDEyLjI1WiIgZmlsbD0iIzQyODVGNDQiLz4KPHBhdGggZD0iTTEyIDIzQzE1LjI0IDIzIDE3Ljk1IDIxLjk5IDE5LjY4IDIwLjI2TDE1LjY4IDE3LjU3QzE0Ljg0IDE4LjA5IDEzLjY5IDE4LjQzIDEyIDE4LjQzQzguODcgMTguNDMgNi4yMiAxNi4zNiA1LjQ2IDEzLjU4SDEuMzNWMTYuNDVDMy4wOCAyMS4zNyA3LjIgMjMgMTIgMjNaIiBmaWxsPSIjMzRBODUzIi8+CjxwYXRoIGQ9Ik01LjQ2IDEzLjU4QzUuMjYgMTIuOTIgNS4xNiAxMi4yMiA1LjE2IDEwLjVDNS4xNiAxMC43OCA1LjI2IDEwLjA4IDUuNDYgOS40MlY2LjU1SDEuMzNDMS4xMiA3LjMzIDEgOC4xNCAxIDlDMSA5Ljg2IDEuMTIgMTAuNjcgMS4zMyAxMS40NUw1LjQ2IDEzLjU4WiIgZmlsbD0iI0ZCQ0MwNSIvPgo8cGF0aCBkPSJNMTIgNS4wN0MxMy42MiA1LjA3IDE1LjA2IDUuNjQgMTYuMTIgNi42OEwxOS4wNCAzLjc2QzE3Ljk1IDIuNzUgMTUuMjQgMSAxMiAxQzcuMiAxIDMuMDggMi42MyAxLjMzIDcuNTVMNS40NiA5LjQyQzYuMjIgNi42NCA4Ljg3IDQuNTcgMTIgNC41N1Y1LjA3WiIgZmlsbD0iI0VBNDMzQyIvPgo8L3N2Zz4K" alt="Google" class="provider-icon">
                    Test Google Auth
                </button>
                <button id="appleLoginBtn" class="button apple">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE4LjcxIDE5LjVjLS4xOSAwLS4zOC0uMDctLjUyLS4yMWwtNC4yNC00LjI0Yy0uMjgtLjI4LS4yOC0uNzMgMC0xLjAxbDQuMjQtNC4yNGMuMjgtLjI4LjczLS4yOCAxLjAxIDBsNC4yNCA0LjI0Yy4yOC4yOC4yOC43MyAwIDEuMDFsLTQuMjQgNC4yNGMtLjE0LjE0LS4zMy4yMS0uNTIuMjFaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTIuNSAyMS41Yy0uMTkgMC0uMzgtLjA3LS41Mi0uMjFsLTQuMjQtNC4yNGMtLjI4LS4yOC0uMjgtLjczIDAtMS4wMWw0LjI0LTQuMjRjLjI4LS4yOC43My0uMjggMS4wMSAwbDQuMjQgNC4yNGMuMjguMjguMjguNzMgMCAxLjAxbC00LjI0IDQuMjRjLS4xNC4xNC0uMzMuMjEtLjUyLjIxWiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+Cg==" alt="Apple" class="provider-icon">
                    Test Apple Auth
                </button>
                <button id="lineLoginBtn" class="button line">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE5LjM2NSAxMi4wMDFDMTkuMzY1IDExLjQ0OSAxOC45MTYgMTEuMDAxIDE4LjM2NSAxMS4wMDFIMTUuNjM1QzE1LjA4NCAxMS4wMDEgMTQuNjM1IDExLjQ0OSAxNC42MzUgMTIuMDAxQzE0LjYzNSAxMi41NTIgMTUuMDg0IDEzLjAwMSAxNS42MzUgMTMuMDAxSDE4LjM2NUMxOC45MTYgMTMuMDAxIDE5LjM2NSAxMi41NTIgMTkuMzY1IDEyLjAwMVoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0xMi4wMDEgMTkuMzY1QzExLjQ0OSAxOS4zNjUgMTEuMDAxIDE4LjkxNiAxMS4wMDEgMTguMzY1VjE1LjYzNUMxMS4wMDEgMTUuMDg0IDExLjQ0OSAxNC42MzUgMTIuMDAxIDE0LjYzNUMxMi41NTIgMTQuNjM1IDEzLjAwMSAxNS4wODQgMTMuMDAxIDE1LjYzNVYxOC4zNjVDMTMuMDAxIDE4LjkxNiAxMi41NTIgMTkuMzY1IDEyLjAwMSAxOS4zNjVaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTIuMDAxIDkuMzY1QzExLjQ0OSA5LjM2NSAxMS4wMDEgOC45MTYgMTEuMDAxIDguMzY1VjUuNjM1QzExLjAwMSA1LjA4NCAxMS40NDkgNC42MzUgMTIuMDAxIDQuNjM1QzEyLjU1MiA0LjYzNSAxMy4wMDEgNS4wODQgMTMuMDAxIDUuNjM1VjguMzY1QzEzLjAwMSA4LjkxNiAxMi41NTIgOS4zNjUgMTIuMDAxIDkuMzY1WiIgZmlsbD0id2hpdGUiLz4KPHBhdGggZD0iTTQuNjM1IDEyLjAwMUM0LjYzNSAxMS40NDkgNS4wODQgMTEuMDAxIDUuNjM1IDExLjAwMUg4LjM2NUM4LjkxNiAxMS4wMDEgOS4zNjUgMTEuNDQ5IDkuMzY1IDEyLjAwMUM5LjM2NSAxMi41NTIgOC45MTYgMTMuMDAxIDguMzY1IDEzLjAwMUg1LjYzNUM1LjA4NCAxMy4wMDEgNC42MzUgMTIuNTUyIDQuNjM1IDEyLjAwMVoiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=" alt="LINE" class="provider-icon">
                    Test LINE Auth
                </button>
                <button id="logoutBtn" class="button secondary">üö™ Sign Out</button>
            </div>
        </div>

        <div id="dataDisplay" class="data-display">
            <div class="data-section">
                <h3>üë§ User Basic Information</h3>
                <div id="basicInfo"></div>
            </div>

            <div class="data-section">
                <h3>üìß Email Information</h3>
                <div id="emailInfo"></div>
            </div>

            <div class="data-section">
                <h3>üì± Phone Number Information</h3>
                <div id="phoneInfo"></div>
            </div>

            <div class="data-section">
                <h3>üîó Provider Information</h3>
                <div id="providerInfo"></div>
            </div>

            <div class="data-section">
                <h3>üîç Raw Provider Data</h3>
                <div id="rawData"></div>
            </div>

            <div class="summary">
                <h3>üìã Summary & Trust Analysis</h3>
                <div id="summaryInfo"></div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
            getAuth,
            GoogleAuthProvider,
            signInWithPopup,
            OAuthProvider,
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC4pMv-UMVU4hqkSV-FaEiA1Z0txFo9j0I",
            authDomain: "traveltech-f0674.firebaseapp.com",
            projectId: "traveltech-f0674",
            storageBucket: "traveltech-f0674.firebasestorage.app",
            messagingSenderId: "843584449870",
            appId: "1:843584449870:web:c5c49bc62b7afe609d021f",
            measurementId: "G-2M28EEC4W7",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Initialize providers
        const googleProvider = new GoogleAuthProvider();
        const appleProvider = new OAuthProvider("apple.com");

        // LINE Functions URL
        const FUNCTIONS_BASE_URL = "https://asia-southeast1-traveltech-f0674.cloudfunctions.net";

        // Add scopes for maximum data access
        googleProvider.addScope("email");
        googleProvider.addScope("profile");
        googleProvider.addScope("phone");
        googleProvider.addScope("openid");

        appleProvider.addScope("email");
        appleProvider.addScope("name");
        appleProvider.addScope("openid");

        // Helper function to create data item
        function createDataItem(label, value, status = null) {
            const item = document.createElement('div');
            item.className = 'data-item';
            
            const labelElement = document.createElement('span');
            labelElement.className = 'data-label';
            labelElement.textContent = label;
            
            const valueElement = document.createElement('span');
            valueElement.className = 'data-value';
            
            if (status) {
                const statusElement = document.createElement('span');
                statusElement.className = `verification-status ${status}`;
                statusElement.textContent = status === 'verified' ? '‚úÖ Verified' : 
                                          status === 'not-verified' ? '‚ùå Not Verified' : '‚ùì Unknown';
                valueElement.appendChild(statusElement);
                valueElement.appendChild(document.createTextNode(' - '));
            }
            
            valueElement.appendChild(document.createTextNode(value || 'N/A'));
            item.appendChild(labelElement);
            item.appendChild(valueElement);
            return item;
        }

        // Function to display user data
        function displayUserData(user, provider = 'firebase') {
            const dataDisplay = document.getElementById('dataDisplay');
            dataDisplay.classList.add('show');

            // Basic Info
            const basicInfo = document.getElementById('basicInfo');
            basicInfo.innerHTML = '';
            basicInfo.appendChild(createDataItem('UID', user.uid));
            basicInfo.appendChild(createDataItem('Display Name', user.displayName));
            basicInfo.appendChild(createDataItem('Provider', provider));

            // Email Info
            const emailInfo = document.getElementById('emailInfo');
            emailInfo.innerHTML = '';
            
            if (user.email) {
                const emailVerified = user.emailVerified !== undefined ? user.emailVerified : 'unknown';
                const emailStatus = emailVerified === true ? 'verified' : 
                                  emailVerified === false ? 'not-verified' : 'unknown';
                emailInfo.appendChild(createDataItem('Email', user.email, emailStatus));
            } else {
                emailInfo.appendChild(createDataItem('Email', 'Not provided'));
            }

            // Phone Info
            const phoneInfo = document.getElementById('phoneInfo');
            phoneInfo.innerHTML = '';
            
            if (user.phoneNumber) {
                phoneInfo.appendChild(createDataItem('Phone Number', user.phoneNumber));
                // Note: Firebase doesn't provide phone verification status in user object
                phoneInfo.appendChild(createDataItem('Phone Verification Status', 'Unknown (Firebase doesn\'t expose this)'));
            } else {
                phoneInfo.appendChild(createDataItem('Phone Number', 'Not provided'));
                phoneInfo.appendChild(createDataItem('Phone Verification Status', 'N/A'));
            }

            // Provider Info
            const providerInfo = document.getElementById('providerInfo');
            providerInfo.innerHTML = '';
            
            if (user.providerData && user.providerData.length > 0) {
                user.providerData.forEach((provider, index) => {
                    providerInfo.appendChild(createDataItem(`Provider ${index + 1}`, provider.providerId));
                    if (provider.email) {
                        providerInfo.appendChild(createDataItem(`Provider ${index + 1} Email`, provider.email));
                    }
                    if (provider.phoneNumber) {
                        providerInfo.appendChild(createDataItem(`Provider ${index + 1} Phone`, provider.phoneNumber));
                    }
                });
            } else {
                providerInfo.appendChild(createDataItem('Linked Providers', 'None'));
            }

            // Raw Data
            const rawData = document.getElementById('rawData');
            rawData.innerHTML = '';
            rawData.appendChild(createDataItem('Raw User Object', JSON.stringify(user, null, 2)));
            if (user.providerData) {
                rawData.appendChild(createDataItem('Raw Provider Data', JSON.stringify(user.providerData, null, 2)));
            }

            // Summary
            const summaryInfo = document.getElementById('summaryInfo');
            summaryInfo.innerHTML = '';
            
            // Email trust analysis
            let emailTrust = '‚ùì Unknown';
            if (user.email) {
                if (user.emailVerified === true) {
                    emailTrust = '‚úÖ Trusted (Verified by Firebase)';
                } else if (user.emailVerified === false) {
                    emailTrust = '‚ùå Not Trusted (Not verified)';
                } else {
                    emailTrust = '‚ö†Ô∏è Partially Trusted (Email present but verification status unknown)';
                }
            } else {
                emailTrust = '‚ùå Not Available';
            }

            // Phone trust analysis
            let phoneTrust = '‚ùì Unknown';
            if (user.phoneNumber) {
                phoneTrust = '‚ö†Ô∏è Partially Trusted (Phone present but verification status not exposed by Firebase)';
            } else {
                phoneTrust = '‚ùå Not Available';
            }

            // Provider-specific analysis
            let providerTrust = '‚ùì Unknown';
            if (user.providerData && user.providerData.length > 0) {
                const primaryProvider = user.providerData[0].providerId;
                if (primaryProvider === 'google.com') {
                    providerTrust = '‚úÖ High Trust (Google verifies email and phone)';
                } else if (primaryProvider === 'apple.com') {
                    providerTrust = '‚úÖ High Trust (Apple verifies email)';
                } else if (primaryProvider === 'line.com') {
                    providerTrust = '‚ö†Ô∏è Medium Trust (LINE provides email but verification status unclear)';
                } else {
                    providerTrust = '‚ö†Ô∏è Medium Trust (Provider verification varies)';
                }
            }

            summaryInfo.appendChild(createDataItem('Email Trust Level', emailTrust));
            summaryInfo.appendChild(createDataItem('Phone Trust Level', phoneTrust));
            summaryInfo.appendChild(createDataItem('Provider Trust Level', providerTrust));
        }

        // Function to display LINE data
        function displayLineData(lineUser, lineProfile, idTokenData) {
            const dataDisplay = document.getElementById('dataDisplay');
            dataDisplay.classList.add('show');

            // Basic Info
            const basicInfo = document.getElementById('basicInfo');
            basicInfo.innerHTML = '';
            basicInfo.appendChild(createDataItem('UID', lineUser.uid));
            basicInfo.appendChild(createDataItem('Display Name', lineUser.displayName));
            basicInfo.appendChild(createDataItem('Provider', 'LINE'));

            // Email Info
            const emailInfo = document.getElementById('emailInfo');
            emailInfo.innerHTML = '';
            
            if (lineUser.email) {
                // LINE doesn't provide email verification status in the standard response
                emailInfo.appendChild(createDataItem('Email', lineUser.email, 'unknown'));
                emailInfo.appendChild(createDataItem('Email Verification Note', 'LINE doesn\'t expose email verification status'));
            } else {
                emailInfo.appendChild(createDataItem('Email', 'Not provided'));
            }

            // Phone Info
            const phoneInfo = document.getElementById('phoneInfo');
            phoneInfo.innerHTML = '';
            phoneInfo.appendChild(createDataItem('Phone Number', 'Not provided by LINE'));
            phoneInfo.appendChild(createDataItem('Phone Verification Status', 'N/A'));

            // Provider Info
            const providerInfo = document.getElementById('providerInfo');
            providerInfo.innerHTML = '';
            providerInfo.appendChild(createDataItem('LINE User ID', lineProfile.userId));
            providerInfo.appendChild(createDataItem('LINE Display Name', lineProfile.displayName));
            if (lineProfile.statusMessage) {
                providerInfo.appendChild(createDataItem('LINE Status Message', lineProfile.statusMessage));
            }

            // Raw Data
            const rawData = document.getElementById('rawData');
            rawData.innerHTML = '';
            rawData.appendChild(createDataItem('LINE User Object', JSON.stringify(lineUser, null, 2)));
            rawData.appendChild(createDataItem('LINE Profile', JSON.stringify(lineProfile, null, 2)));
            rawData.appendChild(createDataItem('LINE ID Token Data', JSON.stringify(idTokenData, null, 2)));

            // Summary
            const summaryInfo = document.getElementById('summaryInfo');
            summaryInfo.innerHTML = '';
            
            let emailTrust = '‚ùì Unknown';
            if (lineUser.email) {
                emailTrust = '‚ö†Ô∏è Partially Trusted (Email present but verification status not provided by LINE)';
            } else {
                emailTrust = '‚ùå Not Available';
            }

            let phoneTrust = '‚ùå Not Available (LINE doesn\'t provide phone numbers)';
            let providerTrust = '‚ö†Ô∏è Medium Trust (LINE provides email but verification status unclear)';

            summaryInfo.appendChild(createDataItem('Email Trust Level', emailTrust));
            summaryInfo.appendChild(createDataItem('Phone Trust Level', phoneTrust));
            summaryInfo.appendChild(createDataItem('Provider Trust Level', providerTrust));
        }

        // Google Login
        document.getElementById('googleLoginBtn').addEventListener('click', async () => {
            try {
                console.log('üîë Testing Google login...');
                const result = await signInWithPopup(auth, googleProvider);
                console.log('‚úÖ Google login successful:', result.user);
                displayUserData(result.user, 'Google');
            } catch (error) {
                console.error('‚ùå Google login error:', error);
                alert(`Google login failed: ${error.message}`);
            }
        });

        // Apple Login
        document.getElementById('appleLoginBtn').addEventListener('click', async () => {
            try {
                console.log('üçé Testing Apple login...');
                const result = await signInWithPopup(auth, appleProvider);
                console.log('‚úÖ Apple login successful:', result.user);
                displayUserData(result.user, 'Apple');
            } catch (error) {
                console.error('‚ùå Apple login error:', error);
                alert(`Apple login failed: ${error.message}`);
            }
        });

        // LINE Login
        document.getElementById('lineLoginBtn').addEventListener('click', async () => {
            try {
                console.log('üü© Testing LINE login...');
                
                // Get authorization URL
                const response = await fetch(`${FUNCTIONS_BASE_URL}/getLineAuthUrlHttp`);
                const authData = await response.json();

                if (!authData.success) {
                    throw new Error(authData.error || 'Failed to get LINE authorization URL');
                }

                // Store state
                localStorage.setItem('lineAuthState', authData.state);
                localStorage.setItem('lineAuthTimestamp', Date.now().toString());

                // Redirect to LINE
                window.location.href = authData.authUrl;
            } catch (error) {
                console.error('‚ùå LINE login error:', error);
                alert(`LINE login failed: ${error.message}`);
            }
        });

        // Check for LINE callback
        const urlParams = new URLSearchParams(window.location.search);
        const lineCode = urlParams.get('code');
        const lineState = urlParams.get('state');

        if (lineCode && lineState) {
            async function processLineCallback() {
                try {
                    const response = await fetch(`${FUNCTIONS_BASE_URL}/processLineCallbackHttp`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            code: lineCode,
                            state: lineState,
                        }),
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Clear URL parameters
                        window.history.replaceState({}, document.title, window.location.pathname);
                        
                        // Display LINE data
                        displayLineData(data.user, data.lineProfile, data.idTokenData);
                    } else {
                        throw new Error(data.error || 'Unknown error');
                    }
                } catch (error) {
                    console.error('Error processing LINE callback:', error);
                    alert(`LINE login failed: ${error.message}`);
                }
            }

            processLineCallback();
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await auth.signOut();
                localStorage.removeItem('lineProfile');
                localStorage.removeItem('lineIdTokenData');
                localStorage.removeItem('lineUser');
                localStorage.removeItem('lineIdToken');
                
                document.getElementById('dataDisplay').classList.remove('show');
                console.log('‚úÖ User signed out successfully');
            } catch (error) {
                console.error('‚ùå Logout error:', error);
            }
        });

        // Check for existing LINE session
        const lineUser = localStorage.getItem('lineUser');
        const lineProfile = localStorage.getItem('lineProfile');
        const lineIdTokenData = localStorage.getItem('lineIdTokenData');

        if (lineUser && lineProfile && lineIdTokenData) {
            displayLineData(
                JSON.parse(lineUser),
                JSON.parse(lineProfile),
                JSON.parse(lineIdTokenData)
            );
        }

        // Auth state listener for Firebase
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('Firebase user detected:', user);
                displayUserData(user, 'Firebase');
            }
        });
    </script>
</body>
</html> 