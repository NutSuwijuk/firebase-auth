# ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ô Firebase Auth Server ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á Local

‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á Firebase Cloud Functions ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Node.js server ‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ô‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á local

## üöÄ ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ô

### 1. ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Dependencies
```bash
npm install
```

### 2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Environment Variables
‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå `.env` ‡∏à‡∏≤‡∏Å `env.example`:
```bash
cp env.example .env
```

‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏ü‡∏•‡πå `.env` ‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:
- `FIREBASE_ADMIN_KEY`: JSON string ‡∏Ç‡∏≠‡∏á Firebase service account
- `LINE_CHANNEL_ID`: LINE Channel ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
- `LINE_CHANNEL_SECRET`: LINE Channel Secret ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

### 3. ‡∏£‡∏±‡∏ô Server
```bash
# ‡∏£‡∏±‡∏ô‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î development (auto-restart ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á)
npm run dev

# ‡∏£‡∏±‡∏ô‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î production
npm start
```

Server ‡∏à‡∏∞‡∏£‡∏±‡∏ô‡∏ó‡∏µ‡πà `http://localhost:3000`

## üì° Endpoints ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà

### Authentication Endpoints
- `POST /api/auth/register` - ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà
- `POST /api/auth/login` - ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
- `GET /api/auth/profile` - ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ token)
- `PUT /api/auth/profile` - ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ token)
- `POST /api/auth/logout` - ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö

### LINE Login Endpoints
- `GET /api/auth/line/auth-url` - ‡πÑ‡∏î‡πâ LINE authorization URL
- `POST /api/auth/line/login` - ‡πÅ‡∏•‡∏Å code ‡πÄ‡∏õ‡πá‡∏ô token
- **`POST /api/auth/line/process-login`** - Process LINE login ‡∏î‡πâ‡∏ß‡∏¢ access token (‡πÅ‡∏õ‡∏•‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å Firebase Function)
- `POST /api/auth/line/verify` - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö LINE token
- `POST /api/auth/line/logout` - ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö LINE
- `GET /api/auth/line/callback` - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ LINE callback

### Firebase Sync Endpoints
- `POST /api/auth/sync-user` - ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å Firebase
- `GET /api/auth/profile-by-firebase/:uid` - ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≤‡∏° Firebase UID
- `PUT /api/auth/update-profile-by-firebase/:uid` - ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≤‡∏° Firebase UID

### Utility Endpoints
- `GET /api/health` - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ server
- `GET /api/users` - ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
- `POST /api/auth/revoke-user` - ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å refresh tokens ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ

## üîß ‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á Firebase Functions

### Firebase Function `processLineLogin` ‚Üí Express Endpoint `/api/auth/line/process-login`

**‡πÄ‡∏î‡∏¥‡∏° (Firebase Functions):**
```javascript
exports.processLineLogin = onRequest(async (request, response) => {
  // ... LINE login logic
});
```

**‡πÉ‡∏´‡∏°‡πà (Express.js):**
```javascript
app.post('/api/auth/line/process-login', async (req, res) => {
  // ... LINE login logic (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
});
```

### Helper Functions ‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏á‡∏°‡∏≤
- `verifyLineAccessToken()` - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö LINE access token
- `getLineProfile()` - ‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• LINE profile
- `createOrUpdateFirebaseUser()` - ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Firebase user

## üåê ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô

### 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Server
```bash
curl http://localhost:3000/api/health
```

### 2. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö LINE Login
```bash
curl -X POST http://localhost:3000/api/auth/line/process-login \
  -H "Content-Type: application/json" \
  -d '{
    "accessToken": "your_line_access_token",
    "email": "user@example.com",
    "displayName": "User Name",
    "pictureUrl": "https://example.com/photo.jpg"
  }'
```

### 3. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Authentication
```bash
# ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "password123",
    "displayName": "Test User"
  }'

# ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "password123"
  }'
```

## ‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á

1. **Firebase Admin SDK**: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ service account key ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
2. **LINE Configuration**: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ LINE Channel ID ‡πÅ‡∏•‡∏∞ Secret ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
3. **Environment Variables**: ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ `.env` file
4. **Security**: ‡πÉ‡∏ô production ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô JWT_SECRET ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ HTTPS

## üêõ ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: Firebase Admin SDK ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ initialize ‡πÑ‡∏î‡πâ
**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:**
- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå `.env` ‡∏°‡∏µ `FIREBASE_ADMIN_KEY` ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
- ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà `serviceAccountKey.json` ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå root

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: LINE API ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á
**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:**
- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö LINE_CHANNEL_ID ‡πÅ‡∏•‡∏∞ LINE_CHANNEL_SECRET
- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö LINE_REDIRECT_URI ‡∏ß‡πà‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô LINE Developer Console

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: CORS Error
**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:**
- Server ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö CORS ‡πÅ‡∏•‡πâ‡∏ß
- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ origin ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô allowedOrigins

## üìö ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°

- [Firebase Admin SDK Documentation](https://firebase.google.com/docs/admin/setup)
- [LINE Login Documentation](https://developers.line.biz/en/docs/line-login/)
- [Express.js Documentation](https://expressjs.com/) 